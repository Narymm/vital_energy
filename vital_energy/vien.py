import logging
from telegram import Update, InlineKeyboardButton, InlineKeyboardMarkup
from telegram.ext import ApplicationBuilder, CommandHandler, CallbackQueryHandler, ConversationHandler, CallbackContext, MessageHandler, filters, ContextTypes
import gspread
from oauth2client.service_account import ServiceAccountCredentials
from datetime import datetime, timedelta
from dotenv import load_dotenv
import os


# –í–∫–ª—é—á–∞–µ–º –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
logging.basicConfig(
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s', level=logging.INFO
)
logger = logging.getLogger(__name__)


# –í—ã–∫–ª—é—á–∞–µ–º –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
logging.disable(logging.CRITICAL)

# –ó–∞–≥—Ä—É–∑–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è –∏–∑ —Ñ–∞–π–ª–∞ .env
load_dotenv()

# –ü–æ–ª—É—á–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–∞ –∏–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è
bot_token = os.getenv('BOT_TOKEN')

# –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏–π –¥–ª—è ConversationHandler
ASK_NAME, QUESTION1, QUESTION2, GET_DATA, RESULT = range(5)

# –í–æ–ø—Ä–æ—Å—ã –∏ –≤–∞—Ä–∏–∞–Ω—Ç—ã –æ—Ç–≤–µ—Ç–æ–≤
questions = [
    "<b>–î–ª—è –Ω–∞—á–∞–ª–∞</b> –≤—ã–±–µ—Ä–∏—Ç–µ —Å–≤–æ–π –ó–ù–ê–ö –ó–û–î–ò–ê–ö–ê",
    "–ó–¥–µ—Å—å –±—É–¥—É—Ç –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω—ã –±–∞–∑–æ–≤—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏.\n‚ú®‚ú®‚ú®\n<i>–î–ª—è –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω–æ–≥–æ —Ä–∞–∑–±–æ—Ä–∞ —É–∫–∞–∂–∏—Ç–µ –≤–∞—à–∏ <b>–¥–∞—Ç—É, –≤—Ä–µ–º—è –∏ –≥–æ—Ä–æ–¥ —Ä–æ–∂–¥–µ–Ω–∏—è</b>.</i>"
]
options = [
    ["–û–≤–µ–Ω", "–¢–µ–ª–µ—Ü", "–ë–ª–∏–∑–Ω–µ—Ü—ã", "–†–∞–∫", "–õ–µ–≤", "–î–µ–≤–∞", "–í–µ—Å—ã", "–°–∫–æ—Ä–ø–∏–æ–Ω", "–°—Ç—Ä–µ–ª–µ—Ü", "–ö–æ–∑–µ—Ä–æ–≥", "–í–æ–¥–æ–ª–µ–π", "–†—ã–±—ã"],
    ["–û—Ç–ø—Ä–∞–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ", "–ù–µ—Ç, —Å–ø–∞—Å–∏–±–æ"]
]

# –û–ø–∏—Å–∞–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –Ω–∞ –æ—Å–Ω–æ–≤–µ –æ—Ç–≤–µ—Ç–æ–≤
results = {
    "–û–≤–µ–Ω": {
        "description": "<i><u>–û–í–ï–ù</u></i>\n\n–ü–æ—Ä–∞ –≤—Å–ø–æ–º–Ω–∏—Ç—å –æ –≤–∞—à–∏—Ö –ª–∏–¥–µ—Ä—Å–∫–∏—Ö –∫–∞—á–µ—Å—Ç–≤–∞—Ö. –í—ã—Ö–æ–¥–∏—Ç–µ –∏–∑ —Ç–µ–Ω–∏, –≤—ã–¥–µ–ª—è–π—Ç–µ—Å—å, –≤—ã—Å—Ç—É–ø–∞–π—Ç–µ –∏–Ω–∏—Ü–∏–∞—Ç–æ—Ä–æ–º –∏ –±–µ—Ä–∏—Ç–µ –Ω–∞ —Å–µ–±—è –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å –∑–∞ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—é –ø—Ä–æ–µ–∫—Ç–æ–≤. –õ—É—á—à–µ –¥–µ–π—Å—Ç–≤–æ–≤–∞—Ç—å –µ–¥–∏–Ω–æ–ª–∏—á–Ω–æ. –ì–æ–≤–æ—Ä–∏—Ç–µ –ø—Ä—è–º–æ –æ —Å–≤–æ–∏—Ö –º—ã—Å–ª—è—Ö –∏ –∏–¥–µ—è—Ö. –í–≤–µ–¥–∏—Ç–µ —Å–∏—Å—Ç–µ–º–Ω—ã–µ —Ñ–∏–∑–∏—á–µ—Å–∫–∏–µ –Ω–∞–≥—Ä—É–∑–∫–∏, —Ç–∞–∫–∏–º –æ–±—Ä–∞–∑–æ–º, –≤—ã –∞–∫—Ç–∏–≤–∏—Ä—É–µ—Ç–µ –≤–∞—à—É –∂–∏–∑–Ω–µ–Ω–Ω—É—é —ç–Ω–µ—Ä–≥–∏—é.",
        "image": os.getenv('OVEN')
    },
    "–¢–µ–ª–µ—Ü": {
        "description": "<i><u>–¢–ï–õ–ï–¶</u></i>\n\n–í—Å–ø–æ–º–Ω–∏—Ç–µ –æ —Ç–æ–º, —á—Ç–æ –≤–∞—Å –∑–∞–∑–µ–º–ª—è–µ—Ç –∏ –ø—Ä–∏–Ω–æ—Å–∏—Ç —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å. –≠—Ç–æ –º–æ–∂–µ—Ç –±—ã—Ç—å –∫–∞–∫ –Ω–∞–∫–æ–ø–ª–µ–Ω–∏–µ –º–∞—Ç–µ—Ä–∏–∞–ª—å–Ω—ã—Ö –±–ª–∞–≥, –∫—Ä–∞—Å–∏–≤—ã—Ö –ø—Ä–µ–¥–º–µ—Ç–æ–≤ –∏—Å–∫—É—Å—Å—Ç–≤–∞, —Ç–∞–∫ –∏ –≤—ã—Ä–∞—â–∏–≤–∞–Ω–∏–µ —Ü–≤–µ—Ç–æ–≤ –≤ —Å–≤–æ—ë —É–¥–æ–≤–æ–ª—å—Å—Ç–≤–∏–µ. –ù–µ—Ç–æ—Ä–æ–ø–ª–∏–≤–æ –ø–æ–≥—Ä—É–∑–∏—Ç–µ—Å—å –≤ –≤–∞—à –ª–∏—á–Ω—ã–π –≥–µ–¥–æ–Ω–∏–∑–º, —ç—Ç–æ –ø—Ä–∏–Ω–µ—Å—ë—Ç –≤–∞–º –∑–∞—Ä—è–¥ —ç–Ω–µ—Ä–≥–∏–∏.",
        "image": os.getenv('TELEC')
    },
    "–ë–ª–∏–∑–Ω–µ—Ü—ã": {
        "description": "<i><u>–ë–õ–ò–ó–ù–ï–¶–´</u></i>\n\n–í–æ–∑–æ–±–Ω–æ–≤–∏—Ç–µ –ø–æ–ª–µ–∑–Ω—ã–µ –∫–æ–º–º—É–Ω–∏–∫–∞—Ü–∏–∏ –∏ –ø–æ–ª—É—á–µ–Ω–∏–µ —Å–≤–µ–∂–µ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏, –≤ —Ç–æ–º —á–∏—Å–ª–µ, –±–ª–∞–≥–æ–¥–∞—Ä—è –æ–±—É—á–µ–Ω–∏—é. –°–º–µ–Ω–∏—Ç–µ –æ–±—Å—Ç–∞–Ω–æ–≤–∫—É, —á—Ç–æ–±—ã –∑–∞—Ä—è–¥–∏—Ç—å—Å—è –Ω–æ–≤—ã–º–∏ –≤–ø–µ—á–∞—Ç–ª–µ–Ω–∏—è–º–∏. –ó–Ω–∞–∫–æ–º—å—Ç–µ—Å—å –∏ –æ–±—â–∞–π—Ç–µ—Å—å, –¥–µ–ª–∏—Ç–µ—Å—å —Å–≤–æ–∏–º–∏ –∑–Ω–∞–Ω–∏—è–º–∏ –∏ —ç–Ω–µ—Ä–≥–∏–µ–π —á–µ—Ä–µ–∑ —Ä–∞–∑–≥–æ–≤–æ—Ä, —á—Ç–æ–±—ã –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å –µ—ë –∏ –ø–æ–ª—É—á–∏—Ç—å –µ—â–µ –±–æ–ª—å—à–µ –≤–∑–∞–º–µ–Ω.",
        "image": os.getenv('BLIZNECU')
    },
    "–†–∞–∫": {
        "description": "<i><u>–†–ê–ö</u></i>\n\n–°–æ–∑–¥–∞–π—Ç–µ —É—é—Ç –≤–æ–∫—Ä—É–≥ —Å–µ–±—è, —á—Ç–æ–±—ã —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω–æ —Ä–∞—Å—Å–ª–∞–±–∏—Ç—å—Å—è –∏ –ø–æ–ª—É—á–∏—Ç—å –∑–∞—Ä—è–¥ —ç–Ω–µ—Ä–≥–∏–∏. –ö–æ–º—Ñ–æ—Ä—Ç–Ω–æ –æ–±—É—Å—Ç—Ä–æ–π—Ç–µ –≤–∞—à–µ –∂–∏–ª—å–µ, –ø–æ–∑–∞–±–æ—Ç—å—Ç–µ—Å—å –æ –¥–µ—Ç—è—Ö –∏ —Å–µ–º—å–µ, –≤–æ–∑–æ–±–Ω–æ–≤–∏—Ç–µ —Å–µ–º–µ–π–Ω—ã–µ —Ç—Ä–∞–¥–∏—Ü–∏–∏, –ø—Ä–∏–≥–æ—Ç–æ–≤—å—Ç–µ –ª—é–±–∏–º–æ–µ –±–ª—é–¥–æ –∏ –ø—Ä–∏–≥–ª–∞—Å–∏—Ç–µ –±–ª–∏–∑–∫–∏—Ö –Ω–∞ –æ–±–µ–¥, –≤—Å–ø–æ–º–Ω–∏—Ç–µ –æ –≤–∞—à–∏—Ö —Ü–µ–Ω–Ω–æ—Å—Ç—è—Ö —Ä–æ–¥–∞. –ê–∫—Ç–∏–≤–∏—Ä—É–π—Ç–µ –≤–∞—à—É —ç–Ω–µ—Ä–≥–∏—é —á–µ—Ä–µ–∑ –ª—é–±–∏–º–æ–µ —Ç–≤–æ—Ä—á–µ—Å—Ç–≤–æ.",
        "image": os.getenv('RAK')
    },
    "–õ–µ–≤": {
        "description": "<i><u>–õ–ï–í</u></i>\n\n–ù–µ–æ–±—Ö–æ–¥–∏–º–æ –≤—ã–±—Ä–∞—Ç—å –¥–µ–ª–æ –∏–ª–∏ –ø—Ä–æ–µ–∫—Ç, –≤ –∫–æ—Ç–æ—Ä–æ–º –≤—ã —Å —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å—é –¥–æ—Å—Ç–∏–≥–Ω–∏—Ç–µ —É—Å–ø–µ—Ö–∞, –≤—ã—Å—Ç—É–ø–∏—Ç–µ –≤ —Ä–æ–ª–∏ –Ω–∞—Å—Ç–æ—è—â–µ–≥–æ –ø—Ä–µ–¥–≤–æ–¥–∏—Ç–µ–ª—è –∏–ª–∏ –∫–æ–º–∞–Ω–¥–∏—Ä–∞ –∏ –ø—Ä–∏–æ–±—Ä–µ—Ç–µ—Ç–µ –¥–æ–ª–≥–æ–∂–¥–∞–Ω–Ω—ã–π –∞–≤—Ç–æ—Ä–∏—Ç–µ—Ç. –ë–ª–∞–≥–æ–¥–∞—Ä—è —ç—Ç–æ–º—É –≤—ã –≤–æ—Å–ø–æ–ª–Ω–∏—Ç–µ—Å—å —ç–Ω–µ—Ä–≥–∏–µ–π, –¥–∞–∂–µ –µ—Å–ª–∏ —Å–ø–µ—Ä–≤–∞ –≤—Å—ë –ø–æ–∫–∞–∂–µ—Ç—Å—è –Ω–µ–∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω—ã–º. –ù–µ –∑–∞–±—ã–≤–∞–π—Ç–µ, –¥–µ–º–æ–Ω—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å —Å–≤–æ–∏ –¥–æ—Å—Ç–æ–∏–Ω—Å—Ç–≤–∞: —â–µ–¥—Ä–æ—Å—Ç—å –∏ –±–ª–∞–≥–æ—Ä–æ–¥—Å—Ç–≤–æ. –ù–µ –ø—Ä–µ–Ω–µ–±—Ä–µ–≥–∞–π—Ç–µ –∞—Ç—Ä–∏–±—É—Ç–∞–º–∏ —Ä–æ—Å–∫–æ—à–∏. –í—Å—ë —ç—Ç–æ –ø—Ä–∏–¥–∞—Å—Ç –≤–∞–º –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π –∑–∞—Ä—è–¥ –∏ –∞–∫—Ç–∏–≤–∏–∑–∏—Ä—É—é—Ç –∂–∏–∑–Ω–µ–Ω–Ω—ã–µ —Å–∏–ª—ã.",
        "image": os.getenv('LEV')
    },
    "–î–µ–≤–∞": {
        "description": "<i><u>–î–ï–í–ê</u></i>\n\n–í—Å–ø–æ–º–Ω–∏—Ç–µ, —á—Ç–æ –∫—Ä–æ–ø–æ—Ç–ª–∏–≤–∞—è —Ä–∞–±–æ—Ç–∞ - –≤–∞—à –∫–æ–Ω—ë–∫. –ù–∏–∫—Ç–æ –ª—É—á—à–µ –≤–∞—Å –Ω–µ —Å–ø—Ä–∞–≤–∏—Ç—Å—è —Å –Ω–µ–π. –ü–æ—ç—Ç–æ–º—É –≤–æ—Å–ø–æ–ª—å–∑—É–π—Ç–µ—Å—å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å—é —Å—Ç–∞—Ç—å –µ—â–µ –±–æ–ª–µ–µ –Ω–µ–∑–∞–º–µ–Ω–∏–º—ã–º –∏ –ø–æ–ª–µ–∑–Ω—ã–º —á–µ–ª–æ–≤–µ–∫–æ–º. –¢–∞–∫–∏–º –æ–±—Ä–∞–∑–æ–º, –≤—ã –∑–∞—Ä—è–¥–∏—Ç–µ—Å—å  –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–º–∏ —ç–º–æ—Ü–∏—è–º–∏. –û–±–ª–∞–≥–æ—Ä–æ–¥—å—Ç–µ –∏ —É–ø–æ—Ä—è–¥–æ—á–∏—Ç–µ –≤–∞—à–µ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–æ, –∑–∞–π–º–∏—Ç–µ—Å—å —Å–≤–æ–∏–º –∑–¥–æ—Ä–æ–≤—å–µ–º –∏ –∫—Ä–∞—Å–æ—Ç–æ–π, –ø–æ—É—Ö–∞–∂–∏–≤–∞–π—Ç–µ –∑–∞ –¥–æ–º–∞—à–Ω–∏–º–∏ –ø–∏—Ç–æ–º—Ü–∞–º–∏, –≤—Å–ø–æ–º–Ω–∏—Ç–µ –æ –ª—é–±–∏–º–æ–º —Ö–æ–±–±–∏. –í—ã–ø–æ–ª–Ω–∏—Ç–µ –ª—é–±—ã–µ –¥–µ–π—Å—Ç–≤–∏—è, –±–ª–∞–≥–æ–¥–∞—Ä—è –∫–æ—Ç–æ—Ä—ã–º –≤—ã –ø–æ—á—É–≤—Å—Ç–≤—É–µ—Ç–µ —Å–µ–±—è –ø–æ–¥ –Ω–∞–¥–µ–∂–Ω–æ–π –∑–∞—â–∏—Ç–æ–π. –î–ª—è –≤–∞—Å —ç—Ç–æ –≤–∞–∂–Ω–æ, –ø–ª—é—Å —ç—Ç–æ –∞–∫—Ç–∏–≤–∏—Ä—É–µ—Ç –≤–∞—à—É —ç–Ω–µ—Ä–≥–∏—é.",
        "image": os.getenv('DEVA')
    },
    "–í–µ—Å—ã": {
        "description": "<i><u>–í–ï–°–´</u></i>\n\n–ü–æ—Å–µ—Ç–∏—Ç–µ –ª—é–±–æ–µ —Å–≤–µ—Ç—Å–∫–æ–µ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ, –≥–¥–µ –≤—ã —Å–º–æ–∂–µ—Ç–µ –ø–æ–ª—É—á–∏—Ç—å —É–¥–æ–≤–æ–ª—å—Å—Ç–≤–∏–µ –æ—Ç –∏—Å–∫—É—Å—Å—Ç–≤–∞ –∏ —ç—Å—Ç–µ—Ç–∏–∫–∏, –∫—Ä–∞—Å–æ—Ç—ã –∏ –ø—Ä–∏—è—Ç–Ω–æ–≥–æ –æ–±—â–µ–Ω–∏—è. –í –ø–æ–≤—Å–µ–¥–Ω–µ–≤–Ω–æ–π –∂–∏–∑–Ω–∏ —Å–æ–∑–¥–∞–π—Ç–µ –≥–∞—Ä–º–æ–Ω–∏—á–Ω–æ–µ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–æ, –≥–¥–µ –≤—ã —Å–º–æ–∂–µ—Ç–µ –Ω–∞–ø–æ–ª–Ω—è—Ç—å—Å—è —ç–Ω–µ—Ä–≥–µ—Ç–∏—á–µ—Å–∫–∏. –ü—Ä–æ—è–≤–∏—Ç–µ –¥–∏–ø–ª–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏ –≤ –ø–µ—Ä–µ–≥–æ–≤–æ—Ä–∞—Ö –∏ –Ω–µ –∑–∞–±—ã–≤–∞–π—Ç–µ, —É –≤–∞—Å —ç—Ç–æ –ø–æ–ª—É—á–∞–µ—Ç—Å—è –ª—É—á—à–µ –≤—Å–µ—Ö.",
        "image": os.getenv('VESU')
    },
    "–°–∫–æ—Ä–ø–∏–æ–Ω": {
        "description": "<i><u>–°–ö–û–†–ü–ò–û–ù</u></i>\n\n–ó–∞–π–º–∏—Ç–µ—Å—å —Ä–∞—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ–º –∫–∞–∫–æ–π-–ª–∏–±–æ –∂–∏–∑–Ω–µ–Ω–Ω–æ–π —Ç–∞–π–Ω—ã, –ø—Ä–∏–∫–æ—Å–Ω–∏—Ç–µ—Å—å –∫ –Ω–µ–∏–∑–≤–µ–¥–∞–Ω–Ω–æ–º—É. –í–∞—à–∏ –ø—Ä–æ–Ω–∏—Ü–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∏ –≤–Ω–∏–º–∞–Ω–∏–µ –∫ –¥–µ—Ç–∞–ª—è–º –Ω–µ –æ—Å—Ç–∞–≤—è—Ç –Ω–∏–∫–æ–≥–æ —Ä–∞–≤–Ω–æ–¥—É—à–Ω—ã–º. –ê–∫—Ç–∏–≤–∏–∑–∏—Ä—É–π—Ç–µ —Å–≤–æ—é —ç–Ω–µ—Ä–≥–∏—é, —Ä–∞—Å–∫—Ä—ã–≤–∞—è —Å–µ–∫—Ä–µ—Ç—ã, –∏ –ø–æ–º–æ–≥–∞—è –¥—Ä—É–≥–∏–º. –ü–æ–≥—Ä—É–∂–∞–π—Ç–µ—Å—å –≤ –ø—Å–∏—Ö–æ–∞–Ω–∞–ª–∏–∑ –∏–ª–∏ —ç–∑–æ—Ç–µ—Ä–∏–∫—É. –°–æ–≤–µ—Ä—à–µ–Ω—Å—Ç–≤—É–π—Ç–µ—Å—å –∏ –Ω–µ –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–π—Ç–µ—Å—å –Ω–∞ —Ä–∞–∑–≤–∏—Ç–∏–∏, —Ç–µ–º —Å–∞–º—ã–º –≤—ã –∞–∫–∫—É–º—É–ª–∏—Ä—É–µ—Ç–µ –≤–∞—à–∏ —Å–∏–ª—ã.",
        "image": os.getenv('SKORPION')
    },
    "–°—Ç—Ä–µ–ª–µ—Ü": {
        "description": "<i><u>–°–¢–†–ï–õ–ï–¶</u></i>\n\n–í–∞–º —Ä–µ–∫–æ–º–µ–Ω–¥—É—é—Ç—Å—è –ø–æ—Å—Ç–æ—è–Ω–Ω–æ —Ä–∞—Å—à–∏—Ä—è—Ç—å –∫—Ä—É–≥–æ–∑–æ—Ä - –ø—É—Ç–µ—à–µ—Å—Ç–≤–æ–≤–∞—Ç—å –∏ –ø–æ–∑–Ω–∞–≤–∞—Ç—å –º–∏—Ä –ª—é–±—ã–º–∏ —Å–ø–æ—Å–æ–±–∞–º–∏. –ò–∑—É—á–∞–π—Ç–µ —è–∑—ã–∫–∏ –∏ —Å—Ç—Ä–∞–Ω—ã, —É—á–∏—Ç–µ—Å—å –∏ —É—á–∏—Ç–µ —Å–∞–º–∏, –æ–±—Ä–µ—Ç–∏—Ç–µ  –¥—É—Ö–æ–≤–Ω–æ–≥–æ –Ω–∞—Å—Ç–∞–≤–Ω–∏–∫–∞. –ü—Ä–∏–º–µ–Ω—è–π—Ç–µ —Å–≤–æ–∏ –∑–Ω–∞–Ω–∏—è, —Å—Ç–∞–Ω–æ–≤–∏—Ç–µ—Å—å –∞–≤—Ç–æ—Ä–∏—Ç–µ—Ç–Ω—ã–º —ç–∫—Å–ø–µ—Ä—Ç–æ–º –≤ —Å–≤–æ–µ–π —Å—Ñ–µ—Ä–µ, –¥–æ—Å—Ç–∏–≥–∞–π—Ç–µ –ø–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω—ã—Ö —Ü–µ–ª–µ–π. –í–∞–º –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ —á—É–≤—Å—Ç–≤–æ–≤–∞—Ç—å —Å–µ–±—è –∑–Ω–∞—á–∏–º—ã–º —á–µ–ª–æ–≤–µ–∫–æ–º, –∫ –∫–æ—Ç–æ—Ä–æ–º—É –≤—Å–µ –º–æ–≥—É—Ç –æ–±—Ä–∞—Ç–∏—Ç—å—Å—è –∑–∞ —Å–æ–≤–µ—Ç–æ–º. –ù–µ –∑–∞–±—ã–≤–∞–π—Ç–µ, —á—Ç–æ —Ç–∞–∫–∏–º –æ–±—Ä–∞–∑–æ–º –≤—ã –ø–æ–ª—É—á–∞–µ—Ç–µ –æ–≥—Ä–æ–º–Ω—ã–π –∑–∞—Ä—è–¥ —ç–Ω–µ—Ä–≥–∏–∏.",
        "image": os.getenv('STRELEC')
    },
    "–ö–æ–∑–µ—Ä–æ–≥": {
        "description": "<i><u>–ö–û–ó–ï–†–û–ì</u></i>\n\n–ù–∞–ø—Ä–∞–≤—å—Ç–µ —Å–≤–æ–π –∫–æ–Ω—Ç—Ä–æ–ª—å –Ω–∞ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–µ –≥–ª–æ–±–∞–ª—å–Ω–æ–π —Ü–µ–ª–∏, –±–ª–∞–≥–æ–¥–∞—Ä—è –∫–æ—Ç–æ—Ä–æ–π –≤—ã –∞–∫—Ç–∏–≤–∏—Ä—É–µ—Ç–µ –≤–∞—à—É —ç–Ω–µ—Ä–≥–∏—é –∏ —É –≤–∞—Å –ø–æ—è–≤—è—Ç—Å—è —Å–∏–ª—ã. –í–∞–∂–Ω–æ –ø–æ–≤—ã—à–∞—Ç—å —Å–æ—Ü–∏–∞–ª—å–Ω—ã–π —Å—Ç–∞—Ç—É—Å –∏ –æ–∫—Ä—É–∂–∞—Ç—å —Å–µ–±—è —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å—é. –í—ã—Å—Ç—Ä–æ–∏—Ç–µ –ª–∏—á–Ω—ã–π –∂–∏–∑–Ω–µ–Ω–Ω—ã–π –ø–ª–∞–Ω, —á—Ç–æ–±—ã —Ç–æ—á–Ω–æ –¥–≤–∏–≥–∞—Ç—å—Å—è –∫ —Å–≤–æ–µ–π –∑–∞–¥–∞—á–µ. –û–≥—Ä–∞–Ω–∏—á—å—Ç–µ —Ö–∞–æ—Å –≤ –∂–∏–∑–Ω–∏ –∏ –∏–∑–ª–∏—à–Ω—é—é —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å, —á—Ç–æ–±—ã —ç—Ç–æ –Ω–µ –æ—Ç–Ω–∏–º–∞–ª–æ –≤–∞—à—É —ç–Ω–µ—Ä–≥–∏—é. –ó–∞—Ä—è–∂–∞–π—Ç–µ—Å—å –æ—Ç –æ–±—â–µ–Ω–∏—è —Å–æ —Å—Ç–∞—Ç—É—Å–Ω—ã–º–∏ –∏ —Å–∏–ª—å–Ω—ã–º–∏ –¥—É—Ö–æ–º –ª—é–¥—å–º–∏.",
        "image": os.getenv('KOZEROG')
    },
    "–í–æ–¥–æ–ª–µ–π": {
        "description": "<i><u>–í–û–î–û–õ–ï–ô</u></i>\n\n–ü—Ä–µ–¥–æ—Å—Ç–∞–≤—å—Ç–µ —Å–µ–±–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å —Å–∞–º–æ–≤—ã—Ä–∞–∂–∞—Ç—å—Å—è. –î–ª—è –≤–∞—Å –≤–∞–∂–Ω–æ —á—É–≤—Å—Ç–≤–æ–≤–∞—Ç—å –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å –∏ —Å–≤–æ–±–æ–¥—É –≤ –¥–µ–π—Å—Ç–≤–∏—è—Ö. –≠—Ç–æ –≤–∞—à –∏—Å—Ç–æ—á–Ω–∏–∫ —ç–Ω–µ—Ä–≥–∏–∏. –ù–µ –∑–∞–±—ã–≤–∞–π—Ç–µ, –≤–∞—Å —Ü–µ–Ω—è—Ç –∑–∞ –∫—Ä–µ–∞—Ç–∏–≤–Ω–æ—Å—Ç—å, –¥—Ä—É–∂–µ–ª—é–±–∏–µ –∏ —É–º–µ–Ω–∏–µ –ø–æ–¥–¥–µ—Ä–∂–∞—Ç—å —Ä–∞–∑–≥–æ–≤–æ—Ä, —Å –∫–µ–º –±—ã —Ç–æ –Ω–∏ –±—ã–ª–æ. –í—ã —Å–ø–æ—Å–æ–±–Ω—ã —Å–æ–∑–¥–∞–≤–∞—Ç—å –Ω–µ–æ–±—ã–∫–Ω–æ–≤–µ–Ω–Ω—ã–µ –≤–µ—â–∏, –∏–º–µ—è –æ—Å–æ–±–æ–µ —á—É—Ç—å–µ –Ω–∞ —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–µ —Ç–µ–Ω–¥–µ–Ω—Ü–∏–∏. –í–∞—Å —ç—Ç–æ –∑–∞—Ä—è–∂–∞–µ—Ç.",
        "image": os.getenv('VODOLEJ')
    },
    "–†—ã–±—ã": {
        "description": "<i><u>–†–´–ë–´</u></i>\n\n–ù–∞—á–Ω–∏—Ç–µ —Å –≤–∞—à–µ–≥–æ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–≥–æ –º–∏—Ä–∞. –ó–∞–π–º–∏—Ç–µ—Å—å –¥—É—Ö–æ–≤–Ω—ã–º —Ä–∞–∑–≤–∏—Ç–∏–µ–º. –ó–∞—Ä—è–¥–∏—Ç—å—Å—è —ç–Ω–µ—Ä–≥–∏–µ–π –ø–æ–º–æ–≥—É—Ç –º–µ–¥–∏—Ç–∞—Ü–∏–∏, —ç–∑–æ—Ç–µ—Ä–∏–∫–∞, –∏—Å–∫—É—Å—Å—Ç–≤–æ, –≤—ã—Ä–∞–∂–µ–Ω–∏–µ —Å–≤–æ–∏—Ö —Ç–∞–ª–∞–Ω—Ç–æ–≤ —á–µ—Ä–µ–∑ —Ç–≤–æ—Ä—á–µ—Å—Ç–≤–æ. –ü–æ–≥—Ä—É–∑–∏—Ç–µ—Å—å –≤ –ø–æ–∏—Å–∫–∏ —Å–º—ã—Å–ª–æ–≤ —á–µ—Ä–µ–∑ —Ä–µ–ª–∏–≥–∏—é –∏–ª–∏ –ø–æ–º–æ—â—å –±–ª–∏–∂–Ω–µ–º—É. –ë–ª–∞–≥–æ—Ç–≤–æ—Ä–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å, –º–∏–ª–æ—Å–µ—Ä–¥–∏–µ –∏ —Å–æ—Å—Ç—Ä–∞–¥–∞–Ω–∏–µ –ø—Ä–∏–¥–∞—Å—Ç –≤–∞–º —Å–∏–ª. –î–ª—è –≤–∞—Å –≤–∞–∂–Ω–æ –Ω–µ–º–Ω–æ–≥–æ –æ—Ç–¥–∞–≤–∞—Ç—å —á–∞—Å—Ç–∏—á–∫—É —Å–µ–±—è.",
        "image": os.getenv('RUBU')
    }
    # –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∑–Ω–∞–∫–∏ –∑–æ–¥–∏–∞–∫–∞
}

# –ü—É—Ç—å –∫ –ª–æ–∫–∞–ª—å–Ω–æ–º—É –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—é –¥–ª—è –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
WELCOME_PHOTO_PATH = os.getenv('WELCOME_PHOTO_PATH')

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ inline –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã
def create_inline_keyboard(options, row_width=2):
    keyboard = []
    for i in range(0, len(options), row_width):
        keyboard.append([InlineKeyboardButton(option, callback_data=option) for option in options[i:i+row_width]])
    return InlineKeyboardMarkup(keyboard)

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Å—Ç–∞—Ä—Ç–æ–≤–æ–π inline –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã
def start_keyboard():
    keyboard = [[InlineKeyboardButton("‚ö°–£–∑–Ω–∞—Ç—å", callback_data="start_survey")]]
    return InlineKeyboardMarkup(keyboard)

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ Google Sheets
def get_gspread_client():
    scope = ["https://spreadsheets.google.com/feeds", "https://www.googleapis.com/auth/drive"]
    creds = ServiceAccountCredentials.from_json_keyfile_name(os.getenv('GOOGLE_CREDENTIALS_PATH'), scope)
    client = gspread.authorize(creds)
    return client

# –ó–∞–ø–∏—Å—å –¥–∞–Ω–Ω—ã—Ö –≤ Google Sheets
def write_to_google_sheets(user_data):
    client = get_gspread_client()
    sheet = client.open("ChatBotBD").worksheet("Energy")

    # –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –∑–∞–ø–∏—Å–∏
    row = [datetime.now().strftime("%Y-%m-%d %H:%M:%S"), user_data['username'], user_data['telegram_account']] + user_data['answers'] + [user_data.get('addit_data', '')]
    sheet.append_row(row)

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∫–æ–º–∞–Ω–¥—ã /start
async def start(update: Update, context: CallbackContext) -> int:
    with open(WELCOME_PHOTO_PATH, 'rb') as photo:
        await context.bot.send_photo(
            chat_id=update.message.chat_id,
            photo=photo,
            caption='<b><u>–ö–∞–∫ —Ä–∞—Å–∫–∞—á–∞—Ç—å —Å–≤–æ—é —ç–Ω–µ—Ä–≥–∏—é –¥–ª—è —É—Å–ø–µ—à–Ω–æ–π —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏? –ò –Ω–µ –∏–¥—Ç–∏ –Ω–∞ –ø–æ–≤–æ–¥—É –∞–ø–∞—Ç–∏–∏ –∏ –≤—ã–≥–æ—Ä–∞–Ω–∏—è?!</u>\n\n<i>–û—Ç–≤–µ—Ç –ø—Ä–æ—Å—Ç - –Ω–∞–¥–æ ‚ö°Ô∏è—É–∑–Ω–∞—Ç—å –°–ï–ë–Ø –ª—É—á—à–µ.\n\n–ë–ª–∞–≥–æ–¥–∞—Ä—è –∞—Å—Ç—Ä–æ-–±–æ—Ç—É –≤—ã –ø–æ–∑–Ω–∞–∫–æ–º–∏—Ç–µ—Å—å —Å –≤–∞–∂–Ω—ã–º–∏ –¥–µ–π—Å—Ç–≤–∏—è–º–∏, –∫–æ—Ç–æ—Ä—ã–µ —è–≤–ª—è—é—Ç—Å—è –¥–ª—è –≤–∞—Å –ñ–ò–ó–ù–ï–ù–ù–û –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–º–∏, —á—Ç–æ–±—ã –ø—Ä–∏–π—Ç–∏ –∫ –ª–∏—á–Ω–æ–π –†–ï–ê–õ–ò–ó–ê–¶–ò–òüëáüèº</i></b>\n\n<i>–Ø –ù–∞—Ç–∞–ª–∏—è –ë–æ–Ω—É–º, –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π –∏ –¥–∏–ø–ª–æ–º–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∞—Å—Ç—Ä–æ–ª–æ–≥. –ü–æ–º–æ–≥–∞—é –≤–∞–º –Ω–∞–π—Ç–∏ –°–ï–ë–Ø, —Å–≤–æ—é –≤—Ç–æ—Ä—É—é –ü–û–õ–û–í–ò–ù–ö–£, —Ä–µ—à–∏—Ç—å –≤–æ–ø—Ä–æ—Å —Å –ü–ï–†–ï–ï–ó–î–æ–º, –ö–ê–†–¨–ï–†–û–ô –∏ –§–ò–ù–ê–ù–°–ê–ú–ò, –∏ –Ω–µ —Ç–æ–ª—å–∫–æ.</i>',
            parse_mode='HTML',
            reply_markup=start_keyboard()
        )
    return ASK_NAME

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –Ω–∞—á–∞–ª–∞ –æ–ø—Ä–æ—Å–∞
async def start_survey(update: Update, context: CallbackContext) -> int:
    query = update.callback_query
    await query.answer()
    await query.message.reply_text('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ –∏–º—è:')
    return ASK_NAME

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∏–º–µ–Ω–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
async def ask_name(update: Update, context: CallbackContext) -> None:
    context.user_data['username'] = update.message.text
    context.user_data['telegram_account'] = update.message.from_user.username  # –°–æ—Ö—Ä–∞–Ω—è–µ–º –∞–∫–∫–∞—É–Ω—Ç Telegram
    
    # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π answers
    context.user_data['answers'] = []
    
    await update.message.reply_text(
        questions[0],
        parse_mode='HTML',
        reply_markup=create_inline_keyboard(options[0], row_width=3)  # –ó–∞–¥–∞–µ–º 3 –∫–Ω–æ–ø–∫–∏ –≤ —Ä—è–¥—É
    )
    return QUESTION1

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—Ç–≤–µ—Ç–æ–≤ –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã
async def handle_question(update: Update, context: CallbackContext) -> None:
    query = update.callback_query
    await query.answer()
    # –ü–æ–ª—É—á–∞–µ–º answers –∏–ª–∏ —Å–æ–∑–¥–∞–µ–º –ø—É—Å—Ç–æ–π —Å–ø–∏—Å–æ–∫
    answers = context.user_data.setdefault('answers', [])
    answers.append(query.data)
    
    logger.info(f'Answers after appending: {answers}')  # –õ–æ–≥–∏—Ä—É–µ–º –∑–Ω–∞—á–µ–Ω–∏—è answers –ø–æ—Å–ª–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è

    current_state = len(answers)
    
    if current_state < len(questions):  # –£—á–∏—Ç—ã–≤–∞–µ–º, —á—Ç–æ –ø–æ—Å–ª–µ–¥–Ω–∏–π –≤–æ–ø—Ä–æ—Å - —ç—Ç–æ –≤–æ–ø—Ä–æ—Å –æ –¥–∞–Ω–Ω—ã—Ö
        await query.message.reply_text(
            questions[current_state],
            reply_markup=create_inline_keyboard(options[current_state]),
            parse_mode='HTML'
        )
        return QUESTION1 + current_state
    
    elif current_state == len(questions) and query.data == "–û—Ç–ø—Ä–∞–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ":
        await query.message.reply_text(
            '–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ:'
        )
        return GET_DATA

    else:
        logger.info(f'First answer: {answers[0]}')  # –õ–æ–≥–∏—Ä—É–µ–º –ø–µ—Ä–≤—ã–π –æ—Ç–≤–µ—Ç
        first_answer = answers[0]
        result_description = results.get(first_answer, {"description": "–í–∞—à–∏ –æ—Ç–≤–µ—Ç—ã —É–Ω–∏–∫–∞–ª—å–Ω—ã, –∏ –º—ã –Ω–µ –º–æ–∂–µ–º –¥–∞—Ç—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ."})
                
        if result_description:
            description = result_description['description']
            image_path = result_description.get('image')
    
            if image_path:
                try:
                    with open(image_path, 'rb') as photo:
                        await context.bot.send_photo(
                            chat_id=query.message.chat_id,
                            photo=photo,
                            caption=f'<b>–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:</b>\n\n{description}',
                            parse_mode='HTML'
                        )
                except FileNotFoundError:
                    await query.message.reply_text(
                        f'<b>–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:</b>\n\n{description}',
                        parse_mode='HTML'
                    )
            else:
                await query.message.reply_text(
                    f'<b>–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:</b>\n\n{description}',
                    parse_mode='HTML'
                )

        write_to_google_sheets(context.user_data)
        context.user_data['answers'] = []
        await query.message.reply_text('–ü—Ä–∏—Å–æ–µ–¥–∏–Ω—è–π—Ç–µ—Å—å –∫ –º–æ–µ–º—É <a href="https://t.me/astro_nataly_bonum">–¢–ì-–∫–∞–Ω–∞–ª—É</a> –∏ <a href="https://www.instagram.com/nataly_bonum?igsh=MWo5emFvczUwaHUyNQ==">–ò–Ω—Å—Ç–µ</a>, –≥–¥–µ —è –¥–µ–ª—é—Å—å –∞—Å—Ç—Ä–æ-—Ç–µ–Ω–¥–µ–Ω—Ü–∏—è–º–∏ –∏ —Å–≤–æ–µ–π –∂–∏–∑–Ω—å—é.\n–ê —Ç–∞–∫–∂–µ –ø–æ–∑–Ω–∞–∫–æ–º—å—Ç–µ—Å—å —Å –º–æ–∏–º <a href="https://astronbonum.tilda.ws">—Å–∞–π—Ç–æ–º</a>.\n\n‚ù§Ô∏è –ë—É–¥—É –∂–¥–∞—Ç—å –≤–∞—Å —Ç–∞–º!\n\n–î–æ –≤—Å—Ç—Ä–µ—á–∏!',
                                       parse_mode='HTML'
                                       )
        return ConversationHandler.END
    
# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –¥–∞–Ω–Ω—ã—Ö
async def get_addit_data(update: Update, context: CallbackContext) -> None:
    user_input = update.message.text
    context.user_data['addit_data'] = user_input
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –∫–ª—é—á 'answers' –≤ user_data
    answers = context.user_data.get('answers', [])
    logger.info(f'Answers: {answers}')  # –õ–æ–≥–∏—Ä—É–µ–º –∑–Ω–∞—á–µ–Ω–∏—è answers

    # –ï—Å–ª–∏ 'answers' –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –∏–ª–∏ –ø—É—Å—Ç, –∏–Ω—Ñ–æ—Ä–º–∏—Ä—É–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    if not answers:
        await update.message.reply_text(
            '–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –≤–∞—à–∏ –æ—Ç–≤–µ—Ç—ã. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –Ω–∞—á–Ω–∏—Ç–µ –æ–ø—Ä–æ—Å –∑–∞–Ω–æ–≤–æ.',
            parse_mode='HTML'
        )
        return ConversationHandler.END

    first_answer = answers[0]
    result_description = results.get(first_answer, {"description": "–í–∞—à–∏ –æ—Ç–≤–µ—Ç—ã —É–Ω–∏–∫–∞–ª—å–Ω—ã, –∏ –º—ã –Ω–µ –º–æ–∂–µ–º –¥–∞—Ç—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ.", "image": None})

    if result_description:
        description = result_description['description']
        image_path = result_description['image']
        
        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ, –µ—Å–ª–∏ –æ–Ω–æ –µ—Å—Ç—å
        if image_path:
            try:
                with open(image_path, 'rb') as photo:
                    await context.bot.send_photo(
                        chat_id=update.message.chat_id,
                        photo=photo,
                        caption=f'<b>–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:</b>\n\n{description}',
                        parse_mode='HTML'
                    )
            except FileNotFoundError:
                await update.message.reply_text(
                    f'<b>–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:</b>\n\n{description}',
                    parse_mode='HTML'
                )
        else:
            await update.message.reply_text(
                f'<b>–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:</b>\n\n{description}',
                parse_mode='HTML'
            )
    else:
        await update.message.reply_text(
            f'<b>–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:</b>\n\n{result_description}',
            parse_mode='HTML'
        )
    
    write_to_google_sheets(context.user_data)
    context.user_data['answers'] = []
    await update.message.reply_text('<i>–í –±–ª–∏–∂–∞–π—à–µ–µ –≤—Ä–µ–º—è —è —Å–≤—è–∂—É—Å—å —Å –≤–∞–º–∏ ‚ù§Ô∏è\n–ò –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—é <b>–ò–ù–î–ò–í–ò–î–£–ê–õ–¨–ù–£–Æ</b> —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫—É –≤–∞—à–µ–π –≥–ª–∞–≤–Ω–æ–π –ø–ª–∞–Ω–µ—Ç—ã "–õ–∏—á–Ω–æ—Å—Ç–∏" ‚òÄÔ∏è\n–ö–æ—Ç–æ—Ä–∞—è –≤–∞–º –ø–æ–º–æ–∂–µ—Ç –ª—É—á—à–µ <b>–ø–æ–Ω—è—Ç—å –°–ï–ë–Ø</b> –∏ —Å–≤–æ–∏ <b>–ñ–ï–õ–ê–ù–ò–Ø –≤ –∂–∏–∑–Ω–∏!</b></i>\n\n–ê –ø–æ–∫–∞ –≤—ã –º–æ–∂–µ—Ç–µ –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è –∫ –º–æ–µ–º—É <a href="https://t.me/astro_nataly_bonum">–¢–ì-–∫–∞–Ω–∞–ª—É</a> –∏ <a href="https://www.instagram.com/nataly_bonum?igsh=MWo5emFvczUwaHUyNQ==">–ò–Ω—Å—Ç–µ</a>, –≥–¥–µ —è –¥–µ–ª—é—Å—å –∞—Å—Ç—Ä–æ-—Ç–µ–Ω–¥–µ–Ω—Ü–∏—è–º–∏ –∏ —Å–≤–æ–µ–π –∂–∏–∑–Ω—å—é.\n–ê —Ç–∞–∫–∂–µ –ø–æ–∑–Ω–∞–∫–æ–º–∏—Ç—å—Å—è —Å –º–æ–∏–º <a href="https://astronbonum.tilda.ws">—Å–∞–π—Ç–æ–º</a>.\n\n–î–æ —Å–≤—è–∑–∏!', 
                                    parse_mode='HTML'
                                    )
    return ConversationHandler.END

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—Ç–º–µ–Ω—ã –æ–ø—Ä–æ—Å–∞
async def cancel(update: Update, context: CallbackContext) -> None:
    query = update.callback_query
    await query.answer()
    await query.message.reply_text(
        '–û–ø—Ä–æ—Å –ø—Ä–µ—Ä–≤–∞–Ω.'
    )
    return ConversationHandler.END

# –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—à–∏–±–æ–∫
async def error_handler(update: Update, context: CallbackContext) -> None:
    logger.error(f'Update {update} caused error {context.error}')

async def send_ping(context: ContextTypes.DEFAULT_TYPE):
    chat_id = context.job.data
    await context.bot.send_message(chat_id="504662108", text="Ping!")

def main() -> None:
    application = ApplicationBuilder().token(bot_token).build()

    # –°–æ–∑–¥–∞–µ–º JobQueue –¥–ª—è –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏—Ö –∑–∞–¥–∞—á
    job_queue = application.job_queue
    #job_queue.run_repeating(send_ping, interval=3600, first=0, data="504662108")  # –ü—Ä–∏–º–µ—Ä –∑–∞–¥–∞–Ω–∏—è –∑–∞–¥–∞—á–∏
    if job_queue is None:
        print("JobQueue –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω!")
        return

    job_queue.run_repeating(send_ping, interval=timedelta(minutes=180), first=timedelta(seconds=10), name="ping_job", data="chat_id")

    
    conv_handler = ConversationHandler(
        entry_points=[CallbackQueryHandler(start_survey, pattern='start_survey')],
        states={
            ASK_NAME: [MessageHandler(filters.TEXT & ~filters.COMMAND, ask_name)],
            QUESTION1: [CallbackQueryHandler(handle_question, pattern='^(–û–≤–µ–Ω|–¢–µ–ª–µ—Ü|–ë–ª–∏–∑–Ω–µ—Ü—ã|–†–∞–∫|–õ–µ–≤|–î–µ–≤–∞|–í–µ—Å—ã|–°–∫–æ—Ä–ø–∏–æ–Ω|–°—Ç—Ä–µ–ª–µ—Ü|–ö–æ–∑–µ—Ä–æ–≥|–í–æ–¥–æ–ª–µ–π|–†—ã–±—ã)$')],
            QUESTION2: [CallbackQueryHandler(handle_question, pattern='^(–û—Ç–ø—Ä–∞–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ|–ù–µ—Ç, —Å–ø–∞—Å–∏–±–æ)$')],
            GET_DATA: [MessageHandler(filters.TEXT & ~filters.COMMAND, get_addit_data)],
        },
        fallbacks=[CallbackQueryHandler(cancel, pattern="^cancel$")]
    )

    application.add_handler(CommandHandler('start', start))
    application.add_handler(conv_handler)
    application.add_handler(MessageHandler(filters.TEXT & ~filters.COMMAND, cancel))  # –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
    application.add_error_handler(error_handler)

    # –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –∏ –∑–∞–ø—É—Å–∫ –±–æ—Ç–∞
    application.run_polling()

if __name__ == '__main__':
    main()

